<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Blaze IA ‚Äì Double & Crash</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-950 text-slate-50 flex items-center justify-center">
  <div class="max-w-5xl w-full px-4 py-8">
    <!-- HEADER -->
    <div class="mb-6 text-center">
      <h1 class="text-2xl md:text-3xl font-bold flex items-center justify-center gap-2">
        <span class="text-red-400 text-xl">üî•</span>
        <span>Blaze IA ‚Äì Double & Crash</span>
      </h1>
      <p class="text-xs md:text-sm text-slate-300 mt-1">
        Envie um print da Blaze (Double ou Crash) e receba a recomenda√ß√£o da IA.
      </p>
    </div>

    <!-- CARD PRINCIPAL -->
    <div class="bg-gradient-to-b from-slate-900 via-slate-950 to-black rounded-3xl p-6 md:p-8 shadow-[0_0_40px_rgba(0,0,0,0.8)] border border-red-500/40">
      <!-- MODO DE JOGO -->
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
        <div class="flex flex-col gap-1">
          <span class="text-[11px] uppercase tracking-wide text-slate-400">
            Selecionar jogo
          </span>
          <div class="flex flex-wrap gap-2">
            <label class="inline-flex items-center gap-2 px-3 py-2 rounded-full bg-slate-900/80 border border-slate-700 cursor-pointer text-xs md:text-sm">
              <input
                type="radio"
                name="game-mode"
                value="double"
                class="accent-red-500"
                checked
              />
              <span>Blaze Double ‚Äì Branco</span>
            </label>

            <label class="inline-flex items-center gap-2 px-3 py-2 rounded-full bg-slate-900/80 border border-slate-700 cursor-pointer text-xs md:text-sm">
              <input
                type="radio"
                name="game-mode"
                value="crash"
                class="accent-emerald-400"
              />
              <span>Blaze Crash ‚Äì 2x</span>
            </label>
          </div>
        </div>

        <div class="text-[11px] text-slate-400">
          Dica: tire o print completo da tela da Blaze antes de enviar.
        </div>
      </div>

      <!-- PREVIEW -->
      <div class="bg-slate-950/70 rounded-3xl border border-slate-800 p-3 mb-4">
        <div
          id="preview-container"
          class="rounded-2xl overflow-hidden border border-slate-800 bg-slate-900/80 h-52 flex items-center justify-center"
        >
          <p
            id="preview-placeholder"
            class="text-xs text-slate-500 text-center px-4"
          >
            Nenhuma imagem selecionada.<br />
            Toque em <strong>Enviar print</strong> ou cole um print (Ctrl+V no
            PC) para visualizar aqui.
          </p>
          <img
            id="preview-image"
            src=""
            alt="Preview do print da Blaze"
            class="hidden w-full h-full object-cover"
          />
        </div>
      </div>

      <!-- CONTROLES -->
      <div class="flex flex-col md:flex-row items-center gap-3 mb-2">
        <label class="w-full md:w-auto cursor-pointer">
          <input
            id="file-input"
            type="file"
            accept="image/*"
            capture="environment"
            class="hidden"
          />
          <span
            class="inline-flex items-center justify-center w-full md:w-auto px-5 py-3 rounded-full bg-slate-900 border border-slate-600 text-xs md:text-sm font-medium hover:border-slate-400"
          >
            Enviar print
          </span>
        </label>

        <button
          id="analisar-btn"
          class="w-full md:w-auto px-6 py-3 rounded-full text-xs md:text-sm font-semibold bg-gradient-to-r from-red-500 to-amber-400 hover:from-red-400 hover:to-amber-300 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Analisar com IA
        </button>

        <span id="status-text" class="text-[11px] text-slate-300 md:ml-auto">
          Aguardando imagem...
        </span>
      </div>

      <p class="text-[10px] text-slate-500">
        * Esta ferramenta √© apenas auxiliar, n√£o garante resultados e n√£o √©
        recomenda√ß√£o financeira.
      </p>
    </div>

    <!-- RESULTADO -->
    <div
      id="resultado-card"
      class="mt-6 bg-gradient-to-r from-red-900/80 via-rose-800/80 to-amber-900/80 rounded-3xl p-5 md:p-6 border border-red-500/40 shadow-[0_0_40px_rgba(0,0,0,0.7)] hidden"
    >
      <div class="flex items-center justify-between mb-2">
        <span
          class="text-xs font-semibold text-slate-200 uppercase tracking-wide"
        >
          Resposta da IA
        </span>
        <span id="conf-text" class="text-[11px] text-slate-200">
          Confian√ßa: 0%
        </span>
      </div>

      <div
        class="text-3xl md:text-4xl font-black mb-2 text-amber-200"
        id="acao-text"
      >
        N&Atilde;O OPERAR
      </div>

      <p class="text-xs md:text-sm text-slate-100" id="justificativa-text">
        A IA ainda n√£o analisou o print.
      </p>
    </div>
  </div>

  <script>
  const fileInput = document.getElementById("file-input");
  const previewImage = document.getElementById("preview-image");
  const previewPlaceholder = document.getElementById("preview-placeholder");
  const analisarBtn = document.getElementById("analisar-btn");
  const statusText = document.getElementById("status-text");

  const resultadoCard = document.getElementById("resultado-card");
  const acaoText = document.getElementById("acao-text");
  const confText = document.getElementById("conf-text");
  const justificativaText = document.getElementById("justificativa-text");

  let selectedFile = null;

  // Base do backend
  const BASE_URL = "https://blaze-ia-analise.onrender.com";

  // tenta /analisar, depois /api/analisar, depois /
  async function chamarBackend(formData) {
    const caminhos = ["/analisar", "/api/analisar", "/"];
    let ultimoStatus = null;
    let ultimoTexto = "";

    for (const path of caminhos) {
      try {
        const res = await fetch(BASE_URL + path, {
          method: "POST",
          body: formData,
        });

        // se for 404, tenta o pr√≥ximo caminho
        if (res.status === 404) {
          ultimoStatus = res.status;
          ultimoTexto = await res.text().catch(() => "");
          console.warn("404 em", path, "-> tentando pr√≥ximo caminho...");
          continue;
        }

        // qualquer coisa diferente de 404 a gente retorna
        return res;
      } catch (e) {
        console.error("Erro chamando", path, e);
        ultimoStatus = 0;
        ultimoTexto = e?.message || String(e);
      }
    }

    // se nenhum funcionou:
    const err = new Error("Nenhum endpoint respondeu corretamente.");
    err.status = ultimoStatus;
    err.detail = ultimoTexto;
    throw err;
  }

  function getSelectedMode() {
    const radio = document.querySelector('input[name="game-mode"]:checked');
    return radio ? radio.value : "double";
  }

  function setImageFile(file) {
    if (!file) return;

    selectedFile = file;
    const reader = new FileReader();
    reader.onload = (ev) => {
      previewImage.src = ev.target.result;
      previewImage.classList.remove("hidden");
      previewPlaceholder.classList.add("hidden");
    };
    reader.readAsDataURL(file);
    statusText.textContent = "Imagem carregada. Pronto para analisar.";
  }

  // Abrir seletor ao clicar em "Enviar print"
  document.querySelector("label").addEventListener("click", () => {
    fileInput.click();
  });

  fileInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    setImageFile(file);
  });

  // Colar print (Ctrl+V - desktop)
  document.addEventListener("paste", (e) => {
    const clipboard = e.clipboardData || window.clipboardData;
    if (!clipboard) return;

    let file = null;

    if (clipboard.items && clipboard.items.length) {
      for (let i = 0; i < clipboard.items.length; i++) {
        const item = clipboard.items[i];
        if (item.type.indexOf("image") !== -1) {
          file = item.getAsFile();
          break;
        }
      }
    }

    if (!file && clipboard.files && clipboard.files.length) {
      file = clipboard.files[0];
    }

    if (file) {
      setImageFile(file);
      statusText.textContent =
        "Imagem colada da √°rea de transfer√™ncia. Pronto para analisar.";
      e.preventDefault();
    }
  });

  analisarBtn.addEventListener("click", async () => {
    if (!selectedFile) {
      alert("Selecione ou cole primeiro o print da Blaze.");
      return;
    }

    analisarBtn.disabled = true;
    statusText.textContent = "Analisando print com IA...";
    resultadoCard.classList.add("hidden");

    const formData = new FormData();
    formData.append("image", selectedFile);
    formData.append("modo", getSelectedMode()); // "double" ou "crash"

    try {
      const res = await chamarBackend(formData);

      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        console.error("Erro HTTP do backend:", res.status, txt);
        alert("Erro no servidor de IA: HTTP " + res.status);
        statusText.textContent = "Erro ao analisar. Tente novamente.";
        return;
      }

      const data = await res.json();
      console.log("Resposta da IA:", data);

      const acao = data.acao || "NAO_OPERAR";
      const conf = data.confianca ?? 0.0;
      const justificativa =
        data.justificativa ||
        "Mercado indefinido. IA recomenda n√£o entrar nessa rodada.";

      if (acao === "BRANCO" || acao === "ENTRAR_BRANCO") {
        acaoText.textContent = "ENTRAR NO BRANCO";
        acaoText.className =
          "text-3xl md:text-4xl font-black mb-2 text-amber-200";
      } else if (acao === "CRASH_2X" || acao === "ENTRAR_2X") {
        acaoText.textContent = "ENTRAR AT√â 2x";
        acaoText.className =
          "text-3xl md:text-4xl font-black mb-2 text-emerald-300";
      } else if (acao === "NAO_OPERAR" || acao === "EVITAR") {
        acaoText.textContent = "N√ÉO ENTRAR";
        acaoText.className =
          "text-3xl md:text-4xl font-black mb-2 text-slate-200";
      } else {
        acaoText.textContent = acao.toUpperCase();
        acaoText.className =
          "text-3xl md:text-4xl font-black mb-2 text-slate-100";
      }

      confText.textContent = "Confian√ßa: " + (conf * 100).toFixed(0) + "%";
      justificativaText.textContent = justificativa;

      resultadoCard.classList.remove("hidden");
      statusText.textContent = "An√°lise conclu√≠da.";
    } catch (err) {
      console.error("Erro geral ao chamar backend:", err);
      statusText.textContent = "Erro ao analisar. Tente novamente.";
      alert(
        "Erro ao conectar com o servidor de IA." +
          (err.status ? " C√≥digo: " + err.status : "")
      );
    } finally {
      analisarBtn.disabled = false;
    }
  });
</script>
